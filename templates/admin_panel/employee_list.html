{% extends 'base.html' %}

{% block title %}Employee List - EMS{% endblock %}

{% block content %}
<!-- employee list -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin-bottom: 0;"><i class="bi bi-people-fill"></i> Employee Management</h4>
                <div>
                    <a href="{% url 'admin_panel:export_employees_csv' %}" class="btn btn-success me-2">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                    <a href="{% url 'admin_panel:create_employee' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add New
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- search and filters -->
                <form method="get" class="row mb-4">
                    <div class="col-md-3">
                        <input type="text" name="search" class="form-control" placeholder="Search by name, email, ID..." value="{{ search_query }}">
                    </div>
                    <div class="col-md-2">
                        <select name="role" class="form-select">
                            <option value="">All Roles</option>
                            <option value="Employee" {% if role_filter == 'Employee' %}selected{% endif %}>Employee</option>
                            <option value="HR" {% if role_filter == 'HR' %}selected{% endif %}>HR</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="department" class="form-select">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="status" class="form-select">
                            <option value="">All Status</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                            <option value="locked" {% if status_filter == 'locked' %}selected{% endif %}>Locked</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-info me-2"><i class="bi bi-search"></i> Search</button>
                        <a href="{% url 'admin_panel:employee_list' %}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Clear</a>
                    </div>
                </form>

                <!-- bulk actions -->\n                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="bulkAction('activate')">
                            <i class="bi bi-check-circle"></i> Activate Selected
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="bulkAction('deactivate')">
                            <i class="bi bi-x-circle"></i> Deactivate Selected
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="bulkAction('unlock')">
                            <i class="bi bi-unlock"></i> Unlock Selected
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="bulkAction('delete')">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                    </div>
                    <small class="text-muted ms-2">(<span id="selectedCount">0</span> selected)</small>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>Employee ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Salary</th>
                                <th>Joined</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in employees %}
                            <tr>
                                <td><input type="checkbox" class="employee-checkbox" value="{{ emp.id }}"></td>
                                <td>{{ emp.employee_id|default:"N/A" }}</td>
                                <td>{{ emp.get_full_name|default:"N/A" }}</td>
                                <td>{{ emp.email }}</td>
                                <td><span class="badge bg-secondary">{{ emp.role }}</span></td>
                                <td>{{ emp.department|default:"N/A" }}</td>
                                <td>â‚¹{{ emp.salary|floatformat:2 }}</td>
                                <td>{{ emp.date_of_joining|date:"Y-m-d"|default:"N/A" }}</td>
                                <td>
                                    {% if emp.account_locked %}
                                    <span class="badge bg-dark">Locked</span>
                                    {% elif emp.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'admin_panel:employee_detail' emp.id %}" class="btn btn-sm btn-info" title="View">
                                            <i class="bi bi-eye-fill"></i>
                                        </a>
                                        <a href="{% url 'admin_panel:edit_employee' emp.id %}" class="btn btn-sm btn-warning" title="Edit">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                        <a href="{% url 'admin_panel:toggle_employee_status' emp.id %}" class="btn btn-sm {% if emp.is_active %}btn-secondary{% else %}btn-success{% endif %}" 
                                           onclick="return confirm('Are you sure?')" title="{% if emp.is_active %}Deactivate{% else %}Activate{% endif %}">
                                            <i class="bi bi-{% if emp.is_active %}pause-circle-fill{% else %}play-circle-fill{% endif %}"></i>
                                        </a>
                                        <a href="{% url 'admin_panel:delete_employee' emp.id %}" class="btn btn-sm btn-danger" title="Delete">
                                            <i class="bi bi-trash-fill"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center">No employees found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// select all checkbox
document.getElementById('selectAll').addEventListener('change', function() {
    var checkboxes = document.querySelectorAll('.employee-checkbox');
    for(var i=0; i<checkboxes.length; i++) {
        checkboxes[i].checked = this.checked;
    }
    updateCount();
});

// update count
var empCheckboxes = document.querySelectorAll('.employee-checkbox');
for(var i=0; i<empCheckboxes.length; i++) {
    empCheckboxes[i].addEventListener('change', updateCount);
}

function updateCount() {
    var checked = document.querySelectorAll('.employee-checkbox:checked');
    document.getElementById('selectedCount').textContent = checked.length;
}

// bulk actions
function bulkAction(action) {
    var checked = document.querySelectorAll('.employee-checkbox:checked');
    var ids = [];
    for(var i=0; i<checked.length; i++) {
        ids.push(checked[i].value);
    }
    
    if (ids.length === 0) {
        alert('Please select at least one employee');
        return;
    }
    
    if (!confirm('Are you sure you want to ' + action + ' ' + ids.length + ' employee(s)?')) {
        return;
    }
    
    var formData = new FormData();
    formData.append('action', action);
    for(var i=0; i<ids.length; i++) {
        formData.append('employee_ids[]', ids[i]);
    }
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "admin_panel:bulk_action" %}', {
        method: 'POST',
        body: formData
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(function(error) {
        alert('Error performing bulk action');
        console.log(error);
    });
}

updateCount();
</script>
{% endblock %}
